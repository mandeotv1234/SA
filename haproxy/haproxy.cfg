global
    maxconn 50000
    log stdout local0 info

defaults
    mode http
    timeout connect 5s
    timeout client 300s    # Long timeout for WebSocket
    timeout server 300s
    option httplog
    log global
    option dontlognull

# Stats page for monitoring
listen stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if TRUE

# Frontend - receives client connections
frontend websocket_frontend
    bind *:8005

    # Capture token from query string for consistent hashing
    http-request set-var(txn.token) url_param(token)

    # Sticky session based on token parameter
    stick-table type string len 64 size 100k expire 30m
    stick on var(txn.token)

    # Health check endpoint
    acl is_health path /health
    use_backend health_backend if is_health

    # Default backend for WebSocket connections
    default_backend stream_services

# Backend - stream service instances
backend stream_services
    # Load balancing algorithm: least connections
    balance leastconn

    # Health checks
    option httpchk GET /health
    http-check expect status 200

    # Enable WebSocket support
    option http-server-close
    option forwardfor

    # Stream service instances - Docker Compose service discovery
    server-template stream 10 stream-service:3000 check inter 5s fall 3 rise 2 resolvers docker init-addr none

# Health check backend
backend health_backend
    http-request return status 200 content-type text/plain string "OK"

# Docker DNS resolver
resolvers docker
    nameserver dns 127.0.0.11:53
    resolve_retries 3
    timeout resolve 1s
    timeout retry 1s
    hold valid 10s
