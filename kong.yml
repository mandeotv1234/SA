_format_version: "2.1"

# Phase 3: API Gateway Security Enhancement
# Enhanced Kong configuration with:
# - JWT validation with issuer/audience check
# - Rate limiting per user (100 req/min)
# - RBAC with request-transformer (inject X-User-Id, X-Roles)
# - Request validation (size limits, timeouts)

# 1. Services and Routes
services:
  # Auth Service: No JWT protection (users need to login)
  - name: auth-service
    url: "http://auth-service:8080"
    connect_timeout: 30000
    write_timeout: 30000
    read_timeout: 30000
    routes:
      - name: auth-route
        paths: ["/auth"]
        strip_path: false
    plugins:
      # Rate limiting for auth endpoints (prevent brute force)
      - name: rate-limiting
        config:
          minute: 20  # Max 20 login attempts per minute
          hour: 100   # Max 100 login attempts per hour
          policy: local
          limit_by: ip
          hide_client_headers: false
      
      # Request size limiting
      - name: request-size-limiting
        config:
          allowed_payload_size: 1  # 1 MB max request body

  # Core Service: Protected by JWT
  - name: core-service
    url: "http://core-service:3000"
    connect_timeout: 30000
    write_timeout: 30000
    read_timeout: 30000
    routes:
      - name: api-route
        paths: ["/api"]
        strip_path: true
    plugins:
      # JWT validation with issuer/audience verification
      - name: jwt
        config:
          claims_to_verify: ["exp"]
          key_claim_name: "iss"  # Verify issuer claim
          secret_is_base64: false
          anonymous: null  # Don't allow anonymous access
          run_on_preflight: false
      
      # Rate limiting per authenticated user
      - name: rate-limiting
        config:
          minute: 100   # 100 requests per minute per user
          hour: 1000    # 1000 requests per hour per user
          policy: local
          limit_by: credential
          hide_client_headers: false
      
      # Inject user info headers for downstream services (RBAC)
      - name: request-transformer
        config:
          add:
            headers:
              - "X-User-Id:$(claims.sub)"
              - "X-User-Email:$(claims.email)"
              - "X-Is-VIP:$(claims.is_vip)"
              - "X-Token-JTI:$(claims.jti)"
      
      # Request size limiting
      - name: request-size-limiting
        config:
          allowed_payload_size: 1  # 1 MB max

  # Stream Service (Socket.IO): Protected by JWT
  - name: stream-service
    url: "http://stream-service:3000"
    connect_timeout: 30000
    write_timeout: 30000
    read_timeout: 30000
    routes:
      - name: socketio-route
        paths: ["/socket.io"]
        strip_path: false
    plugins:
      - name: jwt
        config:
          claims_to_verify: ["exp"]
          uri_param_names: ["token"]  # Allow token in query param for WebSocket
          key_claim_name: "iss"
          anonymous: null
      
      - name: rate-limiting
        config:
          minute: 100
          hour: 1000
          policy: local
          limit_by: credential
      
      - name: request-transformer
        config:
          add:
            headers:
              - "X-User-Id:$(claims.sub)"
              - "X-User-Email:$(claims.email)"

  # Investment Service: Protected by JWT
  - name: investment-service
    url: "http://investment-service:8001"
    connect_timeout: 300000
    write_timeout: 300000
    read_timeout: 300000
    routes:
      - name: investment-route
        paths: ["/invest-api"]
        strip_path: true
    plugins:
      - name: jwt
        config:
          claims_to_verify: ["exp"]
          key_claim_name: "iss"
          anonymous: null
      
      - name: rate-limiting
        config:
          minute: 50    # Lower limit for financial operations
          hour: 500
          policy: local
          limit_by: credential
      
      - name: request-transformer
        config:
          add:
            headers:
              - "X-User-Id:$(claims.sub)"
              - "X-User-Email:$(claims.email)"
              - "X-Is-VIP:$(claims.is_vip)"
      
      - name: request-size-limiting
        config:
          allowed_payload_size: 1

  # Payment Service: Protected by JWT with stricter limits
  - name: payment-service
    url: "http://payment-service:8002"
    connect_timeout: 30000
    write_timeout: 30000
    read_timeout: 30000
    routes:
      - name: payment-route
        paths: ["/payment-api"]
        strip_path: true
    plugins:
      - name: jwt
        config:
          claims_to_verify: ["exp"]
          key_claim_name: "iss"
          anonymous: null
      
      - name: rate-limiting
        config:
          minute: 30    # Stricter limit for payment operations
          hour: 300
          policy: local
          limit_by: credential
      
      - name: request-transformer
        config:
          add:
            headers:
              - "X-User-Id:$(claims.sub)"
              - "X-User-Email:$(claims.email)"
              - "X-Is-VIP:$(claims.is_vip)"
      
      - name: request-size-limiting
        config:
          allowed_payload_size: 1

# 2. Consumers with JWT Credentials
consumers:
  - username: shared-auth-consumer
    jwt_secrets:
      - algorithm: RS256
        key: "my-app-auth"  # Must match 'iss' claim in JWT
        rsa_public_key: |
          -----BEGIN PUBLIC KEY-----
          MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA1W4HxmDaLrRtv2RNYFaQ
          f9/th0sm4BOPLf08FFy6IfNANlV81519VvKOYvIfn998kWRR/M/Gm/veNiP909fM
          E+RazuVy08xq0e6ndlFNWlQZpppEFl0lbWAt2cqUjlmYqhTBXAahvErLcxN1sI0t
          3MWgptdcFF9Zin2mMaQiCa3N7kAO+nJA1KFVi9vGxzt5CeNbMXS1v8Ie3N72LY0Y
          udM/wRM85AJHlt2Gfoyc/uWkcu3xGVSu3wkfhjVapyNhOJk6KFj33ewrc93bcOv/
          khSpKfAEMP2eYW3hv27H/cV+ecQmAXHzxc6umdH65T2i/uXuCOMVp7Xc6fV6uoqe
          wwIDAQAB
          -----END PUBLIC KEY-----

# 3. Global Plugins
plugins:
  # CORS configuration
  - name: cors
    config:
      origins: ["http://localhost:5173", "http://myapp.com"]
      methods: ["GET", "POST", "PUT", "DELETE", "OPTIONS", "PATCH"]
      headers: ["Accept", "Accept-Version", "Content-Length", "Content-MD5", "Content-Type", "Date", "Authorization"]
      exposed_headers: ["X-Auth-Token", "X-RateLimit-Limit", "X-RateLimit-Remaining", "Retry-After"]
      credentials: true
      max_age: 3600
  
  # Global request logging for audit
  - name: file-log
    config:
      path: "/tmp/kong-requests.log"
      reopen: true

# Note: JWKS support requires Kong Enterprise or custom plugin
# For CE, public key must be updated manually or via automation script
# See: .kiro/PHASE3_COMPLETION.md for JWKS integration guide
