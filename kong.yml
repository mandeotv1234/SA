_format_version: "2.1"

# 1. Định nghĩa Services và Routes
_services:
  # Auth Service: Không cần bảo vệ bằng JWT (để user còn login)
  - name: auth-service
    url: "http://auth-service:8080"
    routes:
      - name: auth-route
        paths: ["/auth"]
        strip_path: false # Giữ nguyên /auth khi gọi xuống service

  # Core Service: Bảo vệ bằng JWT
  - name: core-service
    url: "http://core-service:3000"
    routes:
      - name: api-route
        paths: ["/api"]
        strip_path: true # Gọi /api/users -> xuống service là /users
    plugins:
      - name: jwt
        config:
          # Kong sẽ tìm credential khớp với trường 'iss' (issuer) trong token hoặc mặc định
          claims_to_verify: ["exp"] 

  # Stream Service (Socket.IO): Bảo vệ bằng JWT
  - name: stream-service
    url: "http://stream-service:3000"
    routes:
      - name: socketio-route
        paths: ["/socket.io"]
        strip_path: false # Socket.IO cần đúng path này
    plugins:
      - name: jwt
        config:
          claims_to_verify: ["exp"]
          # Cho phép đọc token từ query param ?token=... (cần thiết cho Websocket handshake)
          uri_param_names: ["token"] 

# 2. Định nghĩa Consumer chứa Public Key (Đây là chỗ cấu hình Key đúng)
consumers:
  - username: shared-auth-consumer
    jwt_secrets:
      - algorithm: RS256
        # Key này dùng để khớp với claim 'iss' hoặc chỉ cần 1 key duy nhất nếu config lỏng
        key: "http://auth-service:8080" # HOẶC điền giá trị 'iss' trong token của bạn vào đây
        rsa_public_key: |
          -----BEGIN PUBLIC KEY-----
          MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA1W4HxmDaLrRtv2RNYFaQ
          f9/th0sm4BOPLf08FFy6IfNANlV81519VvKOYvIfn998kWRR/M/Gm/veNiP909fM
          E+RazuVy08xq0e6ndlFNWlQZpppEFl0lbWAt2cqUjlmYqhTBXAahvErLcxN1sI0t
          3MWgptdcFF9Zin2mMaQiCa3N7kAO+nJA1KFVi9vGxzt5CeNbMXS1v8Ie3N72LY0Y
          udM/wRM85AJHlt2Gfoyc/uWkcu3xGVSu3wkfhjVapyNhOJk6KFj33ewrc93bcOv/
          khSpKfAEMP2eYW3hv27H/cV+ecQmAXHzxc6umdH65T2i/uXuCOMVp7Xc6fV6uoqe
          wwIDAQAB
          -----END PUBLIC KEY-----

# 3. Global Plugins
_plugins:
  - name: cors
    config:
      # KHÔNG ĐƯỢC DÙNG "*" nếu credentials: true. Hãy điền domain frontend của bạn.
      origins: ["http://localhost:5173", "http://myapp.com"] 
      methods: ["GET","POST","PUT","DELETE","OPTIONS"]
      headers: ["Accept", "Accept-Version", "Content-Length", "Content-MD5", "Content-Type", "Date", "Authorization"]
      exposed_headers: ["X-Auth-Token"]
      credentials: true
      max_age: 3600

  - name: rate-limiting
    config:
      minute: 1000
      policy: local
      # Tốt nhất nên limit theo IP để tránh 1 người spam hết quota của cả hệ thống
      limit_by: ip